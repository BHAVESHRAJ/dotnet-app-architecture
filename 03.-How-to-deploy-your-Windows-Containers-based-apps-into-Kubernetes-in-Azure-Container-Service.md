# Deploying eShopModernizedMVC to Kubernetes
1. Topic:
   - Sub-topic
      * Sub-Sub-topic

This post describes how to deploy eShopModernizedMVC to Kubernetes but deploying the eShopModernizedWebForms should be pretty similar, so you can use almost the same procedure but using different deployment .yml files.
 
Deploying to Kubernetes from scratch a 2-step process:
- Deploy a K8s cluster
- Deploy the application and related resources

## Position PowerShell into the eShopModernizedMVC-K8s\ServiceDeployments folder
Clone the Repo code into your hard drive.
Open a PowerShell with Admin privileges and run:
   `cd C:\Your-Path-to-eShopModernizing\Kubernetes\eShopModernizedMVC-K8s\**ServiceDeployments**`

## Connect to Azure from PowerShell
1. Login to Azure with:

   `az login`

2. If you have multiple Azure subscriptions, select the one you whish to work with:

   `az account set --subscription [my-azure-subscription-guid]`

3. Check your default subscription with:

   `az account show`

## Deploying the Kubernetes Cluster in Azure Container Service (ACS)

In order to deploy Windows Containers we need a Kubernetes cluster with Windows nodes instead of Linux. 
However, the Master node will be a Linux node.

Yo can find additional generic info on Kubernetes deployment into ACS in this post:
https://docs.microsoft.com/en-us/azure/container-service/kubernetes/container-service-kubernetes-windows-walkthrough

1. **Create an Azure Resource Group** to hold everything related to the Kubernetes cluster and delete everything in a single step whenever you need to. Of course, you can choose your own name for the Resource Group: 

   `az group create --name eShopK8sWinResGrp --location westus`

2. **Create the Kubernetes cluster** (you should use your own cluster name, user name and password):

   `az acs create --orchestrator-type=kubernetes --resource-group eShopK8sWinResGrp --name=eShopK8sWinCluster --agent-count=2 --generate-ssh-keys --windows --admin-username youruser --admin-password your@password`

   If re-using already an created ssh key pair, you can add something like the following:

   `--ssh-key-value ~/acs/sshkeys/acscesar.pub \`

3. **Install kubectl** if you don't have it installed in your PC
   To connect to the Kubernetes cluster from your client computer, use kubectl, the Kubernetes command-line client.

   If you're using Azure CloudShell, kubectl is already installed. 

   If you want to install it locally, you can use the az acs kubernetes install-cli command.
   The following Azure CLI example installs kubectl to your system. 
   On Windows, run this command as an administrator:

   `az acs kubernetes install-cli`

4. **Connect to the Kubernetes cluster** and set the ssh key files to your local PC

   `az acs kubernetes get-credentials --resource-group=eShopK8sWinResGrp --name=eShopK8sWinCluster`

   Again, if re-using an already created ssh key pair, you can add something like the following:

   `--ssh-key-value ~/acs/sshkeys/acscesar.pub \`

5. **Check the connection with kubectl** connecting to the cluster by retrieving nodes list: 

   `kubectl get nodes`
   ![kubectl-get-nodes](https://user-images.githubusercontent.com/1712635/30344662-1301075c-97b7-11e7-93c4-aa7f8c7cc251.png)

6. Open the Kubernetes Dashboard to check what’s going on in the cluster using a browser.
    - Open another PowerShell and run this command:

    `kubectl proxy`
    ![image](https://user-images.githubusercontent.com/1712635/30345183-088e05e8-97b9-11e7-85f6-9087108e61d2.png)
    - Now, open a browser and type the following to Connect to Kubernetes Dashboard:

    `http://localhost:8001/ui`
     
     ![image](https://user-images.githubusercontent.com/1712635/30345114-d232ae04-97b8-11e7-9b33-fe7345ef6975.png)
     Leave it open so that you can check there, changes applied later.
   
## Deploying the eShopModernizedMVC app into the Kubernetes Cluster
1. In case you are positioned in a different place, make sure you move, in PowerShell, to your deployment file path:

   `cd C:\Your-Path-to-eShopModernizing\Kubernetes\eShopModernizedMVC-K8s\**ServiceDeployments**`

3. Use or create a similar deployment file [eshop-modernized-mvc-k8s-services-deployment.yml](https://github.com/dotnet-architecture/eShopModernizing/blob/master/Kubernetes/eShopModernizedMVC-K8s/ServiceDeployments/eshop-modernized-mvc-k8s-services-deployment.yml) than the one with the following content:

`
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: sql-data
spec:
  template:
    metadata:
      labels:
        app: eshop-modernized-mvc
        component: sql-data
    spec:
      containers:
      - name: sql-data
        image: microsoft/mssql-server-windows-developer
        env:
        - name: ACCEPT_EULA
          value: "Y"
        - name: SA_PASSWORD
          value: Pass@word
      nodeSelector:
       beta.kubernetes.io/os: windows
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: eshop-modernized-mvc
    component: sql-data
  name: sql-data
spec:
  ports:
  - port: 1433
  selector:
    app: eshop-modernized-mvc
    component: sql-data
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: eshop-modernized-mvc
spec:
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  minReadySeconds: 5 
  template:
    metadata:
      labels:
        app: eshop-modernized-mvc
    spec:
      containers:
      - name: eshop-modernized-mvc
        image: eshop/modernizedmvc
        ports:
        - containerPort: 80
        env:
        - name: UseMockData
          value: "False"
        - name: UseCustomizationData
          value: "False"
        - name: ConnectionString
          value: "Server=sql.data;Initial Catalog=Microsoft.eShopOnContainers.Services.CatalogDb;User Id=sa;Password=Pass@word;"
      nodeSelector:
       beta.kubernetes.io/os: windows
---
apiVersion: v1
kind: Service
metadata:
  name: eshop-modernized-mvc
spec:
  type: LoadBalancer
  ports:
  - port: 80
  selector:
    app: eshop-modernized-mvc
`

2. Run 
kubectl create -f eshop-modernized-mvc-k8s-services-deployment.yml
