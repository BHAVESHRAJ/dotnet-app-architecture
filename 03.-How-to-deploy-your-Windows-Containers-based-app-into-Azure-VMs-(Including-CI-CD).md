##  Overview
Deploying to a Docker host on a Windows Server 2016 VM in Azure allows you to have quick dev/test/staging environments where you can run your applications in a common place for testers or business users validating the app. VMs can also be valid for IaaS production environments.

##  Goals for this walkthrough
This walkthrough shows you the multiple alternatives you can have when deploying Windows Containers to Azure VMs based on Windows Server 2016 or later.

## Introduction to Azure VMs for Windows Containers
Virtual Machines for Windows containers are simply VMs based on Windows Server 2016, Windows 10, or later versions, both with Docker engine setup. Usually, you will use Windows Server2016 in the Azure VMs.
**Azure currently provides a VM named “Windows Server 2016 with Containers”** which allows you to try the new Windows Server Container feature with both Windows Server Core and Windows Nano Server Container OS Images installed and ready to use with Docker.

##  Scenarios
There are several scenarios. The following diagrams show you each of them to be detailed in this page.

**SCENARIO A:**
![image](https://user-images.githubusercontent.com/1712635/30402751-b976ac40-9893-11e7-9666-de94de842d31.png)

**SCENARIO B:**
![image](https://user-images.githubusercontent.com/1712635/30402804-d62632a2-9893-11e7-817a-f9f616cdf380.png)

**SCENARIO C:**
![image](https://user-images.githubusercontent.com/1712635/30403848-692350f4-9898-11e7-881a-e302f7fc7385.png)

## Prerequisites
- A Microsoft Azure subscription. If you don't have one, sign up for a free trial [here](https://azure.microsoft.com/en-us/free/).
- Dev machine with Windows 10, Docker for Windows and Visual Studio 2017

## Benefits when using Azure VM for Windows Containers Docker host
Although Windows Containers can be deployed into on-premises Windows Server 2016 VMs, however, when deploying into Azure you get a much easier way to get started with ready-to-use Windows Server Container VMs, a common place in the Internet accessible for testers plus automatic scalability of VMs through Azure scale-sets.

## Deploying a Windows Server 2016 VM in Azure (for Windows Containers)

As mentioned, before starting the walkthrough, you will need an Azure subscription account. If you don’t already have one, sign up for a free 30-day trial here.

### Deploy the Virtual Machine in Azure
First of all, log in to the Azure management portal. Then, click on the “+ New” menu option and then search for **“Windows Server 2016 Datacenter - with Containers”** and select that VM type, as shown in the image below.

![image](https://user-images.githubusercontent.com/1712635/30406957-3215bc20-98aa-11e7-8602-5cdae6f7e523.png)

On the Windows Server 2016 Datacenter – with Containers panel, make sure that Resource Manager is selected in the Select a Deployment Model drop-down menu. Then, click on the “Create” button, as specified in the next image.

![image](https://user-images.githubusercontent.com/1712635/30406974-5238cc04-98aa-11e7-9bdb-0a3be3a9e0af.png)

Then, you will see a panel with the VM settings that you need to select or write as shown in the following screenshot.

![image](https://user-images.githubusercontent.com/1712635/30406999-6d125cc0-98aa-11e7-8681-a6c90a77d6a9.png)

On the Create Virtual Machine panel and within the Basics tab, provide a name for the server, a username for the VM’s administrator account in the User field, type and confirm a password for the account, and finally in the Resource Group field, make sure that Create new is checked, and type a name for the new Resource Group.

Change the Datacenter Location using the drop-down menu, if needed. Finally, hit OK.

In the Choose a size panel set a size for the new VM and hit Select. 

![image](https://user-images.githubusercontent.com/1712635/30407011-8a275db0-98aa-11e7-9b49-8300f1a43464.png)

In the Settings panel, under Storage, set Use Managed Disks to Yes. 
You will also need to create a new Virtual Network (or select an existing one), as in the next image.

![image](https://user-images.githubusercontent.com/1712635/30407029-ab66a8d2-98aa-11e7-8e5a-c1ced1834745.png)

Then, click on OK at the bottom of the Settings panel and finally hit the OK button of the Summary panel to deploy the VM.
The deployment will take a few minutes.

### Connect to the Windows Server 2016 VM using RDP
Once the VM is deployed, you can enter into its configuration panel in Azure portal. Follow the following steps once you are in the VM configuration panel.

- In the Virtual Machine panel, click Connect to open an RDP session to the VM.
- Save the RDP file to your PC and open it by double-clicking on it.
- Click Connect in the Remote Desktop Connection dialog box, as shown in the next image.

    ![image](https://user-images.githubusercontent.com/1712635/30407087-13c69e14-98ab-11e7-991d-b19198602e74.png)

- In the Remote Desktop Connection dialog, check Don’t ask me again for connections to this computer. Then click Connect.
- Enter the admin username and password for the VM in the Windows Security dialog box and click OK, as shown in the next image.

    ![image](https://user-images.githubusercontent.com/1712635/30407156-6d860890-98ab-11e7-9083-8fd33209efcd.png)

- If prompted again, in the Remote Desktop Connection dialog, check Don’t ask me again for connections to this computer. Then click Yes.
- At this point you should be able to see the desktop of the VM and work with it remotely.

### Check Docker engine status for Windows Containers in the VM
This Windows Server 2016 VM is basically a Windows Container Host with Docker Engine running to manage the Windows Containers.
Open a PowerShell console in the Windows Server 2016 by typing “Windows PowerShell” on the start menu.
Type “docker images” to see the already available pre-installed Windows Containers images in the VM. You can see you will have the Windows Server Core and the Windows Nano Server images. You could have downloaded/pulled from Docker Hub, but having them pre-installed in the “Windows Server 2016 Datacenter - with Containers” Azure VM will save you significant time.

![image](https://user-images.githubusercontent.com/1712635/30407204-bc6f1a28-98ab-11e7-90c4-1c4f780a0cbe.png)

## Deploying your containers to the Windows Server based Azure VM

You can deploy containers to Docker hosts in multiple ways. Some ways are better suited for development environments and other ways fit better under production environments. 

### Scenario A: Deploying containers to an Azure VM from a development machine (PC) through Docker engine

In this case, you would have an Azure VM based on Windows Server 2016 but you would deploy to it from a development machine with “Docker for Windows” or “Docker for Mac” by using the regular “docker-compose build”, “docker-compose up” and “docker run” commands, but redirected to the VM as Docker Host in the cloud instead of deploying locally into the local development machine with Docker.

The difference in this case, compared to the “Production environment”, is that you are building the Docker images and creating them in the local image repository at the VM right before deploying the containers into the same VM. You are not using any Docker/Container registry in between.

This is the **Scenario A** introduced right at the beginning of the page:

![image](https://user-images.githubusercontent.com/1712635/30402751-b976ac40-9893-11e7-9666-de94de842d31.png)

#### Setting up the Docker Server for remote connections through Docker CLI

##### Allow remote TCP connection to Docker engine

By default, the Docker Server will only listen on a Named Pipe connection, which cannot be accessed remotely. However, you can add additional listeners very easily.

Perform the following steps in the server (VM) you deployed in Azure:

1. Edit C:\ProgramData\docker\config\daemon.json. If it does not exist, just create the text file.
2. Add or modify the hosts setting and append tcp://0.0.0.0:2375, like in the following JSON snippet.

    `{
    "hosts": ["tcp://0.0.0.0:2375","npipe://"]
    }`

3. Save the file and restart the Docker Service with the command “Restart-Service Docker” from the PowerShell in the server VM.

This configuration will listen for all IP addresses on port 2375 (Default Docker port). However, for real production environments you could also set only specific IP addresses for security reasons.

##### Create NSG rules allowing inbound traffic
A network security group (NSG) contains a list of security rules that allow or deny network traffic to resources connected to Azure Virtual Networks (VNet). You’ll need to create a rule to allow traffic for remote management of your Windows Docker Host.
Make port docker's TLS ports 2375 and 2376 available by creating an NSG rule allowing inbound traffic. Note that for secure connections you only need to allow 2376.
The portal should show an NSG configuration for your VM like the following:

![image](https://user-images.githubusercontent.com/1712635/30407430-06383b20-98ad-11e7-8c17-085b7411bfb2.png)

#### Open the Docker port in the Windows Firewall at the Windows Server VM

In addition, you need to open the port used by Docker in the Windows Firewall, either by manually creating a rule of by running this PowerShell command:

    `PS C:\> netsh advfirewall firewall add rule name="Docker Engine Remote Management" dir=in action=allow protocol=TCP localport=2375-2376`

Or alternatively, using with this other PowerShell command:

    `PS C:\> New-NetFirewallRule -DisplayName 'Docker Engine Remote Management' -Profile @('Domain', 'Public', 'Private') -Direction Inbound -Action Allow -Protocol TCP -LocalPort 2375-2376`

Note that if you also open the 2375 port you’ll be opening a door to anyone, so you might want to open just the secure port and use the certificates for a secure connection.

**IMPORTANT:** You will need to create a similar NSG rule for the HTTP ports that your application uses. In this case, the eShopModernizingMVC app uses the **5114 port**.

#### Create the certificates in the server (Optional but recommended)

If you want to connect securely from the client development machine, you will need to create the certs on the server using [dockertls](https://hub.docker.com/r/stefanscherer/dockertls-windows/). If you're creating the certs with an IP address, you may want to consider a static IP to avoid having to recreate certs when the IP address changes.

Restart the docker service with the ”`Restart-Service Docker`” command from the command prompt.

At this point, remote clients should be able to connect remotely to the Docker server if using the required certificates.

For more information on configuring the Docker Server on Windows check this [documentaion on Windows Containers](https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon).

Additional resources 
- Configuring Docker Engine on Windows Server 2016
https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon
- Generating Certificates without using openSSL in plain PowerShell
https://artisticcheese.wordpress.com/2017/06/10/using-pure-powershell-to-generate-tls-certificates-for-docker-daemon-running-on-windows/
- Container Host Deployment - Windows Server
https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/deploy-containers-on-server
- Considerations for running Docker for Windows Server 2016 with Hyper-V VMs
https://blog.docker.com/2016/10/considerations-running-docker-windows-server-2016-hyper-v-vms/

#### Remotely connecting and deploying containers into the Azure VM from a development machine

You don’t need to use the Docker client CLI on the same host as the Docker server, the Docker CLI also runs over a network (TCP) connection.

By using this method, you will connect to the Docker host (Windows Containers VM you just set up) from a development machine that has to have Docker Client installed. Usually, you will install “Docker for Windows” or “Docker for Mac” in the development machines, so that you have Docker Client installed. Then, you can use Docker CLI.

##### Copy the client certs into your dev machine for a secure connection (Optional but recommended)

If you want to connect securely to your VM in Azure, you need to your PC or dev machine.
Copy the files ca.pem, 'cert.pem' and 'key.pem' from your user's docker folder on your VM where you generated the certs, e.g. c:\users\cesardl\.docker to you local machine. For example, you can ctrl-c, ctrl-v the files from an RDP session.

##### Setting up the Docker Client for remote connections

You can specify a remote Docker Server when using the Docker Client in two ways:

A. Use the -H or --host command line parameter
B. Set the DOCKER_HOST environment variable

For example, to connect to a remote Docker Server at IP Address 13.91.40.155 on the default 23751 port, run the following commands.

    `PS C:\> docker --host tcp://13.91.44.143:2375 info 
    or
    PS C:\> $ENV:DOCKER_HOST = 'tcp://13.91.44.143:2375'
    PS C:\> docker info`

For instance, the following commands are run from a Windows 10 dev machine which is configured to remotely access the Windows Server VM in Azure we created previously.

![image](https://user-images.githubusercontent.com/1712635/30407695-a16a706c-98ae-11e7-81df-caeb2b05e421.png)

If your VM is set up with a DNS name in Azure, you could also run the same commands against the DNS name in Azure of your VM, like this command.

    `PS C:\> $ENV:DOCKER_HOST = 'tcp://windockerhost.westus.cloudapp.azure.com:2375'
     PS C:\> docker info
    `
At this point, you could run any “docker-compose” or “docker run” command from your development machine and those commands will be executed against the remote Azure VM.

##### Publish the application .NET bits into a folder

Right click the project in VS 2017 and select publish and Folder. Make sure you select/type the path obj\Docker\publish (case sensitive), and finally click on Publish.

![image](https://user-images.githubusercontent.com/1712635/30407748-f7d7bcfc-98ae-11e7-8301-a987be182611.png)

Navigate to the published folder src\eShopModernizedMVC\obj\Docker\publish and make sure the application bits and the Dockerfile are in that folder.

##### Build the Docker images and deploy the images and containers to the remote Windows Server VM in Azure 

Now, open a command line window (either PowerShell or CMD) and go to the root folder of the application where you see the docker-compose.yml files, like with:

    `cd yourPath\eShopModernizedMVCSolution`

Then, build the custom Docker image and run the application container into the remote Docker Host (Windows Server VM in Azure) with the docker-compose up command, like the following.

    `\> Docker-compose up`

You will see a similar output to the following image.

![image](https://user-images.githubusercontent.com/1712635/30407784-3fc413ee-98af-11e7-84e9-4a76b7cf731d.png)

Note that the first time you run “docker-compose up” it will take quite a few minutes as it will need to download the SQL Server image, from Docker Hub, into the remote Azure VM. This is only needed the first time. 

If you didn’t change the $ENV:DOCKER_HOST environment variable in your console window, then the deployment will be performed in your local development machine (i.e. Windows 10) where you have installed Docker for Windows. But if you changed that environment variable, then the Docker commands are sent to the remote Windows Server 2016 VM in Azure.
At this point, the .NET application and SQL Server are both running as Windows Containers in the remote VM, as you can check by typing “docker ps” to see the containers and by typing “docker images” to see the registered images in the remote VM, as shown in the following screenshots.

![image](https://user-images.githubusercontent.com/1712635/30407832-abaaba86-98af-11e7-8676-7f16191b6c98.png)


![image](https://user-images.githubusercontent.com/1712635/30407870-e7bc6bbe-98af-11e7-90fb-79d9386d68e5.png)

Finally, and provided that you have the Azure NSG rules and the Windows Server Firewall rules allowing the traffic through the TCP port used by the application (in this case the port 5114), you could test the MVC application from any machine in the Internet, like in image X-XX which uses the URL http://windockerhost.westus.cloudapp.azure.com:5114/ but the public IP could also be used like with http://your_VM_IP:5114/ 

![image](https://user-images.githubusercontent.com/1712635/30407887-04be8e68-98b0-11e7-8d0c-7f757826523c.png)

To go back and use a local Docker Server over named pipes in your local development machine, use a command like the following:

`PS C:\> docker --host npipe:////./pipe/docker_engine`

Additional resources 
- Remote Management of a Windows Docker Host
    https://docs.microsoft.com/en-us/virtualization/windowscontainers/management/manage_remotehost







## Deploying from VSTS CD pipeline to Azure VM 
- TBD (Plain)