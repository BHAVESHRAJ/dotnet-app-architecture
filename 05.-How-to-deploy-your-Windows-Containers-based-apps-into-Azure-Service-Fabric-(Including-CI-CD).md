##  Overview
Applications based on Windows Containers will soon need to use platforms going further from IaaS VMs in order to easily achieve a better automated scalability, high scalability and significant improvement in automated deployments and versioning. You can achieve those goals with the orchestrator Azure Service Fabric, available in Microsoft Azure cloud but also on-premises or even in any other public cloud you’d like to deploy it.

Running an existing application in a Windows container on a Service Fabric cluster doesn't require any changes to your application.
This walkthrough assumes a basic understanding of Docker. You can learn about Docker by reading the [Docker Overview](https://docs.docker.com/engine/understanding-docker/).

##  Goals for this walkthrough
This post describes how to deploy eShopModernizedMVC to Kubernetes but deploying the eShopModernizedWebForms should be pretty similar, so you can use almost the same procedure but using different deployment .yml files.

Learn how to deploy a Windows Container based application into a Service Fabric cluster in Azure. Deploying to Service Fabric, from scratch, requires a 2-step process:
1. Deploy a Service Fabric cluster into Azure (Or any other environment)
2. Deploy the application and related resources into the Service Fabric cluster

However, before trying this scenario deploying to an orchestrator, it is recommended that you:
1. Familiarize yourself with the previous sections about containerizing existing .NET Framework apps.
2. You’ve been testing the sample applications (eShopModernizedMVC and/or eShopModernizedWebForms) and running them on a local Docker for Windows dev machine.

##  Scenario

### Scenario A: Direct deployment to Service Fabric cluster from development environment
![image](https://user-images.githubusercontent.com/1712635/30446445-094e998a-993e-11e7-96d8-ed1dd9fef142.png)

### Scenario B: Deployment to to Service Fabric cluster from from CI/CD pipelines in VSTS

TBD


## Prerequisites
- Have ready an Azure subscription
- Have ready a Visual Studio Team Services account (Optional, if deploying from VSTS CD pipeline)
- Visual Studio 2017 on dev machine (Recommended and needed for this specific walkthorugh)
- Access to eShopModernizedMVC image at [Docker Hub](https://hub.docker.com/) (or any other Docker Registry like Azure Container Registry)
- Install [Docker CE for Windows](https://store.docker.com/editions/community/docker-ce-desktop-windows?tab=description) so that you can run containers on Windows 10 (dev machine).
- Install Azure PowerShell
- [Service Fabric Tools](https://blogs.msdn.microsoft.com/azureservicefabric/2017/03/17/visual-studio-2017-and-service-fabric-tools/) are part of the “Azure Development and Management” [workload](https://www.visualstudio.com/vs/visual-studio-workloads/) in Visual Studio 2017. Enable this workload as part of your Visual Studio installation.
- Install Microsoft [Azure Service Fabric SDK](http://www.microsoft.com/web/handlers/webpi.ashx?command=getinstallerredirect&appid=MicrosoftAzure-ServiceFabric-CoreSDK) or higher through the Platform Installer
- Install the [Continuous Delivery Tools extension](https://aka.ms/cd4vs) for Visual Studio 2017 (Optional. Needed for deployment from CD pipeline from VSTS)

It is important that you must, in the first place, have tested either the eShopModernizedMVC or eShopModernizedWebForms container in a local Docker for Windows environment so it is now ready to be built and packaged in a Service Fabric application.

## Creating the Service Fabric cluster in Azure

A [Service Fabric cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-deploy-anywhere) is a network-connected set of virtual or physical machines into which your containers or processes are deployed and managed.

You can create a Service Fabric cluster through several ways:
1. [Create the SF cluster by using the Azure portal](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-portal)
2. [Create a secure SF cluster on Azure using PowerShell](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-tutorial-create-cluster-azure-ps)
3. [Create a secure SF cluster by using Azure Resource Manager](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm)

For production environments it is recommended to create secure clusters based on Certificate keys and probably, running pre-configured PowerShell scripts might be the faster way to do it.

For this initial walkthrough, we're going to use the Azure portal and create an Unsecure cluster with no certificates, so it is faster to get started. However, it is highly recommended to create a secure cluster for production workloads, though, since anyone can anonymously connect to an unsecure cluster and perform management operations.

### Create the cluster

First, log in to the Azure portal at http://portal.azure.com with your subscription credentials.
If you don't have an Azure subscription, create a [free Azure account](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) before you begin.

1. Click the **New** button found on the upper left-hand corner of the Azure portal.
2. Select **Compute** from the **New** blade and then **type "Service Fabric" in the Search** edit-box and hit enter. Then select **Service Fabric Cluster** from the blade, as shown below:

![image](https://user-images.githubusercontent.com/1712635/30459069-36dfec12-9963-11e7-8d5e-b32529ab9826.png)

3. Fill out the Service Fabric **Basics** form. For **Operating system**, select "**Windows Server 2016 Datacenter with Containers**" The user name and password entered here is used to log in to the virtual machine. For **Resource group**, create a new one. A resource group is a logical container into which Azure resources are created and collectively managed. When complete, click OK. 

See screenshot below as reference.
![image](https://user-images.githubusercontent.com/1712635/30459153-c24dfa8c-9963-11e7-92ec-95b151d12c73.png)

4. Fill out the **Cluster configuration** form. For **Node type count**, enter "1".
![image](https://user-images.githubusercontent.com/1712635/30459334-e1b02412-9964-11e7-8bf1-a14b39f66e07.png)

5. Select **Node type 1 (Primary)** and fill out the **Node type configuration** form. Enter a node type name (like "noded1v2" which is based on the type of the VM to be selected)  and set the [Durability tier](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster) to "**Bronze**." Select a VM size.

Node types define the VM size, number of VMs, custom endpoints, and other settings for the VMs of that type. Each node type defined is set up as a separate virtual machine scale set, which is used to deploy and managed virtual machines as a set. Each node type can be scaled up or down independently, have different sets of ports open, and can have different capacity metrics. The first, or primary, node type is where Service Fabric system services are hosted and must have five or more VMs.

For any production deployment, [capacity planning](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity) is an important step. For this quick start, however, you aren't running applications so select a D1_V2 Standard VM size. Select "Silver" for the [reliability tier](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity#the-reliability-characteristics-of-the-cluster) and an initial virtual machine scale set **capacity of 5** VMs.

Custom endpoints open up ports in the Azure load balancer so that you can connect with applications running on the cluster. It is IMPORTANT that you enter at least the ports to be used by the eShopModernized applications.

The list below are ports used by eShopModernizing apps and also other ports used by eShopOnContainers, if you want to deploy multiple applications in the same SF cluster:

    5114, 5433, 80, 81, 82, 83, 84, 85, 88, 8080, 8888, 1433, 443, 5100, 5101, 5102, 5103, 5104, 5105, 5106, 5107, 5108, 5109, 5110, 5112, 5113, 5115, 15672, 5672, 6379 

If you forget any port, you can always download the Azure ARM metadata from your cluster and re-publish.
An additional good way not to need so many ports is to manage a PREFIX per application so you re-use the same port across multiple services and discriminate services based on that PREFIX by using the SF **REVERSE PROXY**.

Do **not** check the **Configure advanced settings** box, which is used for customizing TCP/HTTP management endpoints, application port ranges, [placement constraints](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-resource-manager-configure-services#placement-constraints), and [capacity properties](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-resource-manager-metrics).

See image below as a reference:
![image](https://user-images.githubusercontent.com/1712635/30460079-70fe03a6-9969-11e7-87d8-a68904885927.png)

Select OK (just once).

6. Click on the link "**Show optional settings**" in the Cluster configuration form. Then, make sure **Diagnostics** is set to **On**. 
In "**Add on features**" select "**Include DNS service**" and "**Include repair manager**".
In **Fabric version**, select **Automatic** upgrade mode so that Microsoft automatically updates the version of the fabric code running the cluster. Set the mode to Manual if you want to [choose a supported version](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-upgrade) to upgrade to.

You do not need to enter any "[fabric setting properties](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-fabric-settings)", though.

See image below for reference:
![image](https://user-images.githubusercontent.com/1712635/30460282-bdab5d88-996a-11e7-8e9c-553c62b1cf4c.png)

Select **OK**.

7. At the **Security** form, for this initial walkthrough select **Unsecure**. It is highly recommended to create a secure cluster for production workloads, however, since anyone can anonymously connect to an unsecure cluster and perform management operations.
Certificates are used in Service Fabric to provide authentication and encryption to secure various aspects of a cluster and its applications. For more information on how certificates are used in Service Fabric, see [Service Fabric cluster security scenarios](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-security). To enable user authentication using Azure Active Directory or to set up certificates for application security, [create a cluster from a Resource Manager template](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm).

![image](https://user-images.githubusercontent.com/1712635/30460401-9b1850c2-996b-11e7-8780-e5a5975bab36.png)

Select **OK**.

8. Review the summary. If you'd like to download a Resource Manager template built from the settings you entered, select **Download template and parameters** (This is what you do if you need to add ports in the future, btw). 
Select **Create** to create the cluster.

You can see the creation progress in the notifications. (Click the "Bell" icon near the status bar at the upper right of your screen.) If you clicked **Pin to Startboard** while creating the cluster, you see **Deploying Service Fabric Cluster** pinned to the **Start** board.

### View cluster status in Azure portal

Once your cluster is created, you can inspect your cluster in the **Overview** blade in the portal. You can now see the details of your cluster in the dashboard, including the VMs used by the cluster, the cluster's public endpoint and a link to Service Fabric Explorer.

Nodes/VMs used by the cluster, as shown in Azure portal:
![image](https://user-images.githubusercontent.com/1712635/30460923-00a9c9cc-996f-11e7-8155-ae1511ca8b35.png)

### Visualize the cluster using Service Fabric explorer

[Service Fabric Explorer](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-visualizing-your-cluster) is a good tool for visualizing your cluster and managing applications. **Service Fabric Explorer** is a service that runs in the cluster. Access it using a web browser by clicking the **Service Fabric Explorer** link of the **cluster Overview** page in the portal. 
You can also enter the address directly into the browser: 
    http://eshopmodernizedcluster.westus.cloudapp.azure.com:19080/Explorer

The cluster dashboard provides an overview of your cluster, including a summary of application and node health. The node view shows the physical layout of the cluster. For a given node, you can inspect which applications have code deployed on that node.

![image](https://user-images.githubusercontent.com/1712635/30460995-74b1ee80-996f-11e7-833a-d96e42edd136.png)

### How to delete the cluster

A Service Fabric cluster is made up of other Azure resources in addition to the cluster resource itself. So, to completely delete a Service Fabric cluster you also need to delete all the resources it is made of. The simplest way to delete the cluster and all the resources it consumes is to delete the resource group you created when creating the cluster. 


## Have the eShopModernizedMVC or eShopModernizedWebForms Docker image ready at any Docker Registry

Once you have the container image built on your machine, you can push it to any container registry (like Docker Hub or Azure Container Registry) so Service Fabric will be able to pull it down and deploy it as a Windows Container.
If you want to publish your own images, follow a similar procedure than this one used in the "Deployment to VMs" post: [Publish the image in a Docker Registry](https://github.com/dotnet-architecture/eShopModernizing/wiki/03.-How-to-deploy-your-Windows-Containers-based-app-into-Azure-VMs-(Including-CI-CD)#publish-the-image-in-a-docker-registry-docker-hub-of-azure-container-registry).

However, and for simplicity's sake, you can also use the, already published, public eShopModernized Docker images available at Docker Hub and published by our team. Those images are available here:

**eShopModernizedMVC Windows Docker Image:** [https://hub.docker.com/r/eshop/modernizedmvc/](https://hub.docker.com/r/eshop/modernizedmvc/) 

**eShopModernizedWebForms Windows Docker Image:** [https://hub.docker.com/r/eshop/modernizedmvc/](https://hub.docker.com/r/eshop/modernizedmvc/) 

So, you'd be able to deploy those images by simply using the current dockerfiles in the solution which are referencing to these Docker **image names**:

    eshop/modernizedmvc
    eshop/modernizewebforms


## Deploying the eShopModernizedMVC app Windows Containers into the SF cluster

### Create the containerized SF service in Visual Studio

Either use the already pre-created SF project available at eShopModernizedMVC or create your own by following the next steps:

The Service Fabric SDK and tools provide a service template to help you create a containerized application.
1. Start Visual Studio. Select **File > New > Project**.
2. Select **Service Fabric application**, name it "**eShopModernizedMVC-ServiceFabricApp**", and click **OK**.
3. Select **Container** from the list of **service templates**.
4. In **Image Name** enter "eshop/modernizedmvc" (our public image at Docker Hub) or use the image you pushed to your container registry.
5. Give your service a name, like "**MVC_Container**", and click OK.

See image below as reference.
![image](https://user-images.githubusercontent.com/1712635/30461319-6611b5a6-9972-11e7-81d0-9d99e523257d.png)

### Configure communication
The containerized service needs an endpoint for communication. Add an `Endpoint` element with the protocol, port, and type to the **ServiceManifest.xml** file. In this case, the containerized service listens on port 5114. In this example, a fixed port 5114 is used. If no port is specified, a random port from the application port range is chosen.

    <Resources>
      <Endpoints>
        <Endpoint Name="MVC_ContainerTypeEndpoint" UriScheme="http" Port="5114" Protocol="http"/>
      </Endpoints>
    </Resources>

## Deploying from VSTS CD pipeline to Service Fabric  
- TBD (Plain)



