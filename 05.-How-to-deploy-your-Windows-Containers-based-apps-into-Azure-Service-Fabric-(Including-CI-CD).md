##  Overview
Applications based on Windows Containers will soon need to use platforms going further from IaaS VMs in order to easily achieve a better automated scalability, high scalability and significant improvement in automated deployments and versioning. You can achieve those goals with the orchestrator Azure Service Fabric, available in Microsoft Azure cloud but also on-premises or even in any other public cloud you’d like to deploy it.

Running an existing application in a Windows container on a Service Fabric cluster doesn't require any changes to your application.
This walkthrough assumes a basic understanding of Docker. You can learn about Docker by reading the [Docker Overview](https://docs.docker.com/engine/understanding-docker/).

##  Goals for this walkthrough
This post describes how to deploy eShopModernizedMVC to Kubernetes but deploying the eShopModernizedWebForms should be pretty similar, so you can use almost the same procedure but using different deployment .yml files.

Learn how to deploy a Windows Container based application into a Service Fabric cluster in Azure. Deploying to Service Fabric, from scratch, requires a 2-step process:
1. Deploy a Service Fabric cluster into Azure (Or any other environment)
2. Deploy the application and related resources into the Service Fabric cluster

However, before trying this scenario deploying to an orchestrator, it is recommended that you:
1. Familiarize yourself with the previous sections about containerizing existing .NET Framework apps.
2. You’ve been testing the sample applications (eShopModernizedMVC and/or eShopModernizedWebForms) and running them on a local Docker for Windows dev machine.

##  Scenario

### Scenario A: Direct deployment to Service Fabric cluster from development environment
![image](https://user-images.githubusercontent.com/1712635/30446445-094e998a-993e-11e7-96d8-ed1dd9fef142.png)

### Scenario B: Deployment to to Service Fabric cluster from from CI/CD pipelines in VSTS

TBD


## Prerequisites
- Have ready an Azure subscription
- Have ready a Visual Studio Team Services account (Optional, if deploying from VSTS CD pipeline)
- Visual Studio 2017 on dev machine (Recommended and needed for this specific walkthorugh)
- Access to eShopModernizedMVC image at [Docker Hub](https://hub.docker.com/) (or any other Docker Registry like Azure Container Registry)
- Install [Docker CE for Windows](https://store.docker.com/editions/community/docker-ce-desktop-windows?tab=description) so that you can run containers on Windows 10 (dev machine).
- Install Azure PowerShell
- [Service Fabric Tools](https://blogs.msdn.microsoft.com/azureservicefabric/2017/03/17/visual-studio-2017-and-service-fabric-tools/) are part of the “Azure Development and Management” [workload](https://www.visualstudio.com/vs/visual-studio-workloads/) in Visual Studio 2017. Enable this workload as part of your Visual Studio installation.
- Install Microsoft [Azure Service Fabric SDK](http://www.microsoft.com/web/handlers/webpi.ashx?command=getinstallerredirect&appid=MicrosoftAzure-ServiceFabric-CoreSDK) or higher through the Platform Installer
- Install the [Continuous Delivery Tools extension](https://aka.ms/cd4vs) for Visual Studio 2017 (Optional. Needed for deployment from CD pipeline from VSTS)

It is important that you must, in the first place, have tested either the eShopModernizedMVC or eShopModernizedWebForms container in a local Docker for Windows environment so it is now ready to be built and packaged in a Service Fabric application.

## Creating the Service Fabric cluster in Azure

A [Service Fabric cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-deploy-anywhere) is a network-connected set of virtual or physical machines into which your containers or processes are deployed and managed.

You can create a Service Fabric cluster through several ways:
1. [Create the SF cluster by using the Azure portal](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-portal)
2. [Create a secure SF cluster on Azure using PowerShell](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-tutorial-create-cluster-azure-ps)
3. [Create a secure SF cluster by using Azure Resource Manager](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm)

For production environments it is recommended to create secure clusters based on Certificate keys and probably, running pre-configured PowerShell scripts might be the faster way to do it.

For this initial walkthrough, we're going to use the Azure portal and create an Unsecure cluster with no certificates, so it is faster to get started. However, it is highly recommended to create a secure cluster for production workloads, though, since anyone can anonymously connect to an unsecure cluster and perform management operations.

### Create the cluster

First, log in to the Azure portal at http://portal.azure.com with your subscription credentials.
If you don't have an Azure subscription, create a [free Azure account](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) before you begin.

1. Click the **New** button found on the upper left-hand corner of the Azure portal.
2. Select **Compute** from the **New** blade and then **type "Service Fabric" in the Search** edit-box and hit enter. Then select **Service Fabric Cluster** from the blade, as shown below:

![image](https://user-images.githubusercontent.com/1712635/30459069-36dfec12-9963-11e7-8d5e-b32529ab9826.png)

3. Fill out the Service Fabric **Basics** form. For **Operating system**, select "**Windows Server 2016 Datacenter with Containers**" The user name and password entered here is used to log in to the virtual machine. For **Resource group**, create a new one. A resource group is a logical container into which Azure resources are created and collectively managed. When complete, click OK. 

See screenshot below as reference.
![image](https://user-images.githubusercontent.com/1712635/30459153-c24dfa8c-9963-11e7-92ec-95b151d12c73.png)

4. Fill out the **Cluster configuration** form. For **Node type count**, enter "1".
![image](https://user-images.githubusercontent.com/1712635/30459334-e1b02412-9964-11e7-8bf1-a14b39f66e07.png)

5. Select **Node type 1 (Primary)** and fill out the **Node type configuration** form. Enter a node type name (like "noded1v2" which is based on the type of the VM to be selected)  and set the [Durability tier](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster) to "**Bronze**." Select a VM size.

Node types define the VM size, number of VMs, custom endpoints, and other settings for the VMs of that type. Each node type defined is set up as a separate virtual machine scale set, which is used to deploy and managed virtual machines as a set. Each node type can be scaled up or down independently, have different sets of ports open, and can have different capacity metrics. The first, or primary, node type is where Service Fabric system services are hosted and must have five or more VMs.

For any production deployment, [capacity planning](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity) is an important step. For this quick start, however, you aren't running applications so select a D1_V2 Standard VM size. Select "Silver" for the [reliability tier](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity#the-reliability-characteristics-of-the-cluster) and an initial virtual machine scale set **capacity of 5** VMs.

Custom endpoints open up ports in the Azure load balancer so that you can connect with applications running on the cluster. It is IMPORTANT that you enter at least the ports to be used by the eShopModernized applications.

The list below are ports used by eShopModernizing apps and also other ports used by eShopOnContainers, if you want to deploy multiple applications in the same SF cluster:

    5114, 5433, 80, 81, 82, 83, 84, 85, 88, 8080, 8888, 1433, 443, 5100, 5101, 5102, 5103, 5104, 5105, 5106, 5107, 5108, 5109, 5110, 5112, 5113, 5115, 15672, 5672, 6379 

If you forget any port, you can always download the Azure ARM metadata from your cluster and re-publish.
An additional good way not to need so many ports is to manage a PREFIX per application so you re-use the same port across multiple services and discriminate services based on that PREFIX by using the SF **REVERSE PROXY**.

Do **not** check the **Configure advanced settings** box, which is used for customizing TCP/HTTP management endpoints, application port ranges, [placement constraints](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-resource-manager-configure-services#placement-constraints), and [capacity properties](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-resource-manager-metrics).

See image below as a reference:
![image](https://user-images.githubusercontent.com/1712635/30460079-70fe03a6-9969-11e7-87d8-a68904885927.png)

Select OK (just once).

6. Click on the link "**Show optional settings**" in the Cluster configuration form. Then, make sure **Diagnostics** is set to **On**. 
In "**Add on features**" select "**Include DNS service**" and "**Include repair manager**".
In **Fabric version**, select **Automatic** upgrade mode so that Microsoft automatically updates the version of the fabric code running the cluster. Set the mode to Manual if you want to [choose a supported version](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-upgrade) to upgrade to.

You do not need to enter any "[fabric setting properties](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-fabric-settings)", though.

See image below for reference:
![image](https://user-images.githubusercontent.com/1712635/30460282-bdab5d88-996a-11e7-8e9c-553c62b1cf4c.png)

Select **OK**.

7. At the **Security** form, for this initial walkthrough select **Unsecure**. It is highly recommended to create a secure cluster for production workloads, however, since anyone can anonymously connect to an unsecure cluster and perform management operations.
Certificates are used in Service Fabric to provide authentication and encryption to secure various aspects of a cluster and its applications. For more information on how certificates are used in Service Fabric, see [Service Fabric cluster security scenarios](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-security). To enable user authentication using Azure Active Directory or to set up certificates for application security, [create a cluster from a Resource Manager template](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm).

![image](https://user-images.githubusercontent.com/1712635/30460401-9b1850c2-996b-11e7-8780-e5a5975bab36.png)

Select **OK**.

8. Review the summary. If you'd like to download a Resource Manager template built from the settings you entered, select **Download template and parameters** (This is what you do if you need to add ports in the future, btw). 
Select **Create** to create the cluster.

You can see the creation progress in the notifications. (Click the "Bell" icon near the status bar at the upper right of your screen.) If you clicked **Pin to Startboard** while creating the cluster, you see **Deploying Service Fabric Cluster** pinned to the **Start** board.

### View cluster status in Azure portal

Once your cluster is created, you can inspect your cluster in the **Overview** blade in the portal. You can now see the details of your cluster in the dashboard, including the VMs used by the cluster, the cluster's public endpoint and a link to Service Fabric Explorer.

Nodes/VMs used by the cluster, as shown in Azure portal:
![image](https://user-images.githubusercontent.com/1712635/30460923-00a9c9cc-996f-11e7-8155-ae1511ca8b35.png)

### Visualize the cluster using Service Fabric explorer

[Service Fabric Explorer](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-visualizing-your-cluster) is a good tool for visualizing your cluster and managing applications. **Service Fabric Explorer** is a service that runs in the cluster. Access it using a web browser by clicking the **Service Fabric Explorer** link of the **cluster Overview** page in the portal. 
You can also enter the address directly into the browser: 
    http://eshopmodernizedcluster.westus.cloudapp.azure.com:19080/Explorer

The cluster dashboard provides an overview of your cluster, including a summary of application and node health. The node view shows the physical layout of the cluster. For a given node, you can inspect which applications have code deployed on that node.

![image](https://user-images.githubusercontent.com/1712635/30460995-74b1ee80-996f-11e7-833a-d96e42edd136.png)

### How to delete the cluster

A Service Fabric cluster is made up of other Azure resources in addition to the cluster resource itself. So, to completely delete a Service Fabric cluster you also need to delete all the resources it is made of. The simplest way to delete the cluster and all the resources it consumes is to delete the resource group you created when creating the cluster. 


## Have the eShopModernizedMVC or eShopModernizedWebForms Docker image ready at any Docker Registry

Once you have the container image built on your machine, you can push it to any container registry (like Docker Hub or Azure Container Registry) so Service Fabric will be able to pull it down and deploy it as a Windows Container.
If you want to publish your own images, follow a similar procedure than this one used in the "Deployment to VMs" post: [Publish the image in a Docker Registry](https://github.com/dotnet-architecture/eShopModernizing/wiki/03.-How-to-deploy-your-Windows-Containers-based-app-into-Azure-VMs-(Including-CI-CD)#publish-the-image-in-a-docker-registry-docker-hub-of-azure-container-registry).

However, and for simplicity's sake, you can also use the, already published, public eShopModernized Docker images available at Docker Hub and published by our team. Those images are available here:

**eShopModernizedMVC Windows Docker Image:** [https://hub.docker.com/r/eshop/modernizedmvc/](https://hub.docker.com/r/eshop/modernizedmvc/) 

**eShopModernizedWebForms Windows Docker Image:** [https://hub.docker.com/r/eshop/modernizedmvc/](https://hub.docker.com/r/eshop/modernizedmvc/) 

So, you'd be able to deploy those images by simply using the current dockerfiles in the solution which are referencing to these Docker **image names**:

    eshop/modernizedmvc
    eshop/modernizewebforms


## Deploying the eShopModernizedMVC app Windows Containers into the SF cluster

If you don't want to create the Service Fabric "service-deployment project" and configure its XML metadata (so you understand it), you can also skip this part in Visual Studio and code files and directly deploy the read-to-deploy eShopModernized SF project available here **(TBD)** and jump to the section **"TBD"**. 

### Create the containerized SF service in Visual Studio

Either use the already pre-created SF project available at eShopModernizedMVC or create your own by following the next steps:

The Service Fabric SDK and tools provide a service template to help you create a containerized application.
1. Start Visual Studio. Select **File > New > Project**.
2. Select **Service Fabric application**, name it "**eShopModernizedMVC-ServiceFabricApp**", and click **OK**.
3. Select **Container** from the list of **service templates**.
4. In **Image Name** enter "eshop/modernizedmvc" (our public image at Docker Hub) or use the image you pushed to your container registry.
5. Give your service a name, like "**MVC_Container**", and click OK.

See image below as reference.
![image](https://user-images.githubusercontent.com/1712635/30461319-6611b5a6-9972-11e7-81d0-9d99e523257d.png)

### Configure communication (external service's endpoint published at the cluster)
The containerized service needs an endpoint for communication. Add an `Endpoint` element with the protocol, port, and type to the **ServiceManifest.xml** file. In this case, the containerized service listens on port 5114. In this example, a fixed port 5114 is used. If no port is specified, a random port from the application port range is chosen.

    <Resources>
      <Endpoints>
        <Endpoint Name="MVC_ContainerTypeEndpoint" UriScheme="http" Port="5114" Protocol="http"/>
      </Endpoints>
    </Resources>

By defining an endpoint, Service Fabric publishes the endpoint to the Naming service. Other services running in the cluster can resolve this container. 
You can also perform container-to-container communication using the reverse proxy. Communication is performed by providing the [reverse proxy](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-reverseproxy) HTTP listening port and the name of the services that you want to communicate with as environment variables.

### Configure and set environment variables

Environment variables can be specified for each code package in the service manifest. This feature is available for all services in Service Fabric irrespective of whether they are deployed as containers or processes or guest executables. You can override environment variable values in the application manifest or specify them during deployment as application parameters.

The following **service manifest** XML snippet shows the **environment variables** needed by the **eShopModernizedMVC** application, like the EF Connection String, use yes/not of mock-data, etc.:


    <CodePackage Name="Code" Version="1.0.0">
      ...    
      <EnvironmentVariables>
        <!-- <EnvironmentVariable Name="VariableName" Value="VariableValue"/> -->
        <EnvironmentVariable Name="ConnectionString" Value="Data Source=SqlData_Container.eShopModernizedMVC_ServiceFabricApp,5433;Database=Microsoft.eShopOnContainers.Services.CatalogDb;User Id=sa;Password=Pass@word"/>
        <EnvironmentVariable Name="PicBaseUrl" Value="http://eshopmodernizedcluster.westus.cloudapp.azure.com:5114/items/[0]/pic/"/>
        <EnvironmentVariable Name="UseMockData" Value="True"/>
        <EnvironmentVariable Name="UseCustomizationData" Value="False"/>
      </EnvironmentVariables>
    </CodePackage>

These environment variables can be overridden in the application manifest, too.

### Configure container port-to-host port mapping and container-to-container discovery

Configure a host port used to communicate with the container. The port binding maps the port on which the service is listening inside the container to a port on the host. Add a `PortBinding` element in `ContainerHostPolicies` element of the **ApplicationManifest.xml** file. 
In the eShopModernizedMVC container, the `ContainerPort` is 80 (the container exposes port 80, internally within the Docker Host, as specified in its original Dockerfile) and `EndpointRef` is "**MVC_ContainerTypeEndpoint**" (the endpoint previously defined in the service manifest). 
Incoming requests to the service on port 5114 at the cluster and nodes are mapped to port 80 on the eShopModernizedMVC container.

    <ServiceManifestImport>
      <ServiceManifestRef ServiceManifestName="MVC_ContainerPkg" ServiceManifestVersion="1.0.0" />
      <ConfigOverrides />
      <Policies>
        <ContainerHostPolicies CodePackageRef="Code">
          <PortBinding ContainerPort="80" EndpointRef="MVC_ContainerTypeEndpoint"/>
        </ContainerHostPolicies>
      </Policies>
    </ServiceManifestImport>


### (OPTIONAL) Configure authentication if using a private container registry (like Azure Container Registry)
If using public images at Docker Hub, you don't need this step.
However, you could configure container registry authentication by adding `RepositoryCredentials` to `ContainerHostPolicies` of the ApplicationManifest.xml file. Add the account and password for the **myregistry.azurecr.io** container registry, which allows the service to download the container image from the private repository in Azure Container Registry (ACR).


### Deploy the containerized application from Visual Studio

To publish your SF application (which was defined simply by the xml manifest files pointing to container images available at a Docker Registry), just right-click on the Service Fabric project (i.e. **eShopModernizedMVC_ServiceFabricApp**) in  **Solution Explorer** in Visual Studio and select **Publish**.

In **Connection Endpoint**, select/enter the management endpoint for the cluster. For example, `eshopmodernizedcluster.westus.cloudapp.azure.com:19000`. You can find the client connection endpoint in the Overview blade for your cluster in the Azure portal.

Click **Publish**.

While publishing, you can see how the application is being deployed by using Service Fabric Explorer. As mentioned before, [Service Fabric Explorer](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-visualizing-your-cluster) is a web-based tool for inspecting and managing applications and nodes in a Service Fabric cluster. Open a browser and navigate to [http://eshopmodernizedcluster.westus.cloudapp.azure.com:19080/Explorer/](http://eshopmodernizedcluster.westus.cloudapp.azure.com:19080/Explorer/) and follow the application deployment. 

The application deploys but won't be ready until the Docker images are downloaded the first time (pulled from the Docker Registry) onto the cluster nodes. This can take some time, depending on the image size. For instance, if including the SQL Server image in the deployment (as configured in the eShopModernizedMVC SF manifest code in the GitHub repo) it will take significant time (just the first time), because the SQL Server image is quite large. 

Below you can see how Service Fabric Explorer shows the eShopModernizedMVC application deployed, in this case, including a second Windows Container with the SQL Server.

![image](https://user-images.githubusercontent.com/1712635/30462085-1e07fb8e-9978-11e7-9b16-fc272a0f04ae.png)

Finally, open a browser and navigate to `http://eshopmodernizedcluster.westus.cloudapp.azure.com:5114`. 
You should see the eShopModernizedMVC web app in the browser.


************ TBD - MVC app screenshot *************


### (OPTIONAL) Adding a SQL Server Windows Container to the applications

If you don't want to use the "mock-data" but to access to a real SQL Server deployed as a container, then you'd need to add a similar SF service to the project by following a similar procedure.

See image below in VS and explore the XML code in the repo to know how easy is to deploy a SQL Server container into Service Fabric.

![image](https://user-images.githubusercontent.com/1712635/30462125-6b6362ec-9978-11e7-91a0-cfbad2c3bc43.png)

**IMPORTANT**: Note that SQL Server in a container should only be used for dev/test environments.
**You should move your database to high available systems, like Azure SQL Database, for production environments**.


### Clean up
You continue to incur charges while the cluster is running, consider [deleting your cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started-azure-cluster#remove-the-cluster). 

[Party clusters](http://tryazureservicefabric.westus.cloudapp.azure.com/) from Azure Service Fabric are automatically deleted after a few hours.


## Deploying from VSTS CD pipeline to Service Fabric  
- TBD (Plain)





Additional resources 
- Prepare your development environment for Service Fabric
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started)
- Create your first Service Fabric cluster on Azure
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started-azure-cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started-azure-cluster)
- Deploy a .NET application in a Windows container to Azure Service Fabric from VSTS and docker-compose
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-host-app-in-a-container](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-host-app-in-a-container)
- Create your first Service Fabric container application on Windows (SF metadata, Visual Studio, Python container)
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started-containers](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started-containers)
- Deploy a Service Fabric Windows container application on Azure (SF metadata and Visual Studio)
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-quickstart-containers](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-quickstart-containers)
- Docker-Compose application support in Azure Service Fabric (Preview)
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-docker-compose#deploy-a-docker-compose-file-on-service-fabric](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-docker-compose#deploy-a-docker-compose-file-on-service-fabric)
- Deploying a Docker-Composed Application on Service Fabric (CLI)
    [http://blog.sluijsveld.com/20/05/2017/DeployingDockerComposedAppOnServiceFabric/](http://blog.sluijsveld.com/20/05/2017/DeployingDockerComposedAppOnServiceFabric/)
- Running Windows Containers on Azure Service Fabric
    [https://loekd.wordpress.com/2017/02/08/running-windows-containers-on-azure-service-fabric/](https://loekd.wordpress.com/2017/02/08/running-windows-containers-on-azure-service-fabric/)
- Create a Service Fabric cluster by using Azure Resource Manager
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm)
- Create a secure cluster on Azure using PowerShell
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-tutorial-create-cluster-azure-ps ](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-tutorial-create-cluster-azure-ps )
- ApplicationInsights SDK for ServiceFabric projects
    [https://github.com/Microsoft/ApplicationInsights-ServiceFabric](https://github.com/Microsoft/ApplicationInsights-ServiceFabric)
- Service Fabric Container Samples (C# Web frontent and Nodejs backend)
    [https://github.com/Azure-Samples/service-fabric-dotnet-containers](https://github.com/Azure-Samples/service-fabric-dotnet-containers)
- Reverse proxy in Azure Service Fabric
    [https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-reverseproxy](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-reverseproxy)
