##  Overview
Applications based on Windows Containers will soon need to use platforms going further from IaaS VMs in order to easily achieve a better automated scalability, high scalability and significant improvement in automated deployments and versioning. You can achieve those goals with the orchestrator Azure Service Fabric, available in Microsoft Azure cloud but also on-premises or even in any other public cloud you’d like to deploy it.

##  Goals for this walkthrough
This post describes how to deploy eShopModernizedMVC to Kubernetes but deploying the eShopModernizedWebForms should be pretty similar, so you can use almost the same procedure but using different deployment .yml files.

Learn how to deploy a Windows Container based application into a Service Fabric cluster in Azure. Deploying to Service Fabric, from scratch, requires a 2-step process:
1. Deploy a Service Fabric cluster into Azure (Or any other environment)
2. Deploy the application and related resources into the Service Fabric cluster

However, before trying this scenario deploying to an orchestrator, it is recommended that you:
1. Familiarize yourself with the previous sections about containerizing existing .NET Framework apps.
2. You’ve been testing the sample applications (eShopModernizedMVC and/or eShopModernizedWebForms) and running them on a local Docker for Windows dev machine.

##  Scenario

### Scenario A: Direct deployment to Service Fabric cluster from development environment
![image](https://user-images.githubusercontent.com/1712635/30446445-094e998a-993e-11e7-96d8-ed1dd9fef142.png)

### Scenario B: Deployment to to Service Fabric cluster from from CI/CD pipelines in VSTS

TBD


## Prerequisites
- Have ready an Azure subscription
- Have ready a Visual Studio Team Services account (Optional, if deploying from VSTS CD pipeline)
- Visual Studio 2017 on dev machine (Recommended and needed for this specific walkthorugh)
- Access to eShopModernizedMVC image at [Docker Hub](https://hub.docker.com/) (or any other Docker Registry like Azure Container Registry)
- Install Docker CE for Windows so that you can run containers on Windows 10 (dev machine).
- Install Azure PowerShell
- [Service Fabric Tools](https://blogs.msdn.microsoft.com/azureservicefabric/2017/03/17/visual-studio-2017-and-service-fabric-tools/) are part of the “Azure Development and Management” [workload](https://www.visualstudio.com/vs/visual-studio-workloads/) in Visual Studio 2017. Enable this workload as part of your Visual Studio installation.
- Install Microsoft [Azure Service Fabric SDK](http://www.microsoft.com/web/handlers/webpi.ashx?command=getinstallerredirect&appid=MicrosoftAzure-ServiceFabric-CoreSDK) or higher through the Platform Installer
- Install the [Continuous Delivery Tools extension](https://aka.ms/cd4vs) for Visual Studio 2017 (Optional. Needed for deployment from CD pipeline from VSTS)

It is important that you must, in the first place, have tested either the eShopModernizedMVC or eShopModernizedWebForms container in a local Docker for Windows environment so it is now ready to be built and packaged in a Service Fabric application.

## Have the eShopModernizedMVC or eShopModernizedWebForms Docker image ready at any Docker Registry

Once you have the container image built on your machine, you can push it to any container registry (like Docker Hub or Azure Container Registry) so Service Fabric will be able to pull it down and deploy it as a Windows Container.
If you want to publish your own images, follow a similar procedure than this one used in the "Deployment to VMs" post: [Publish the image in a Docker Registry](https://github.com/dotnet-architecture/eShopModernizing/wiki/03.-How-to-deploy-your-Windows-Containers-based-app-into-Azure-VMs-(Including-CI-CD)#publish-the-image-in-a-docker-registry-docker-hub-of-azure-container-registry).

However, and for simplicity's sake, you can also use the, already published, public eShopModernized Docker images available at Docker Hub and published by our team. Those images are available here:

**eShopModernizedMVC Windows Docker Image:** [https://hub.docker.com/r/eshop/modernizedmvc/](https://hub.docker.com/r/eshop/modernizedmvc/) 

**eShopModernizedWebForms Windows Docker Image:** [https://hub.docker.com/r/eshop/modernizedmvc/](https://hub.docker.com/r/eshop/modernizedmvc/) 

So, you'd be able to deploy those images by simply using the current dockerfiles in the solution which are referencing to these image names:

    `eshop/modernizedmvc`

    `eshop/modernizewebforms`

## Creating the Service Fabric cluster in Azure

A [Service Fabric cluster](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-deploy-anywhere) is a network-connected set of virtual or physical machines into which your containers or processes are deployed and managed.

You can create a Service Fabric cluster through several ways:
1. [Create the SF cluster by using the Azure portal](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started-azure-cluster)
2. [Create a secure SF cluster on Azure using PowerShell](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-tutorial-create-cluster-azure-ps)
3. [Create a secure SF cluster by using Azure Resource Manager](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm)

For production environments it is recommended to create secure clusters based on Certificate keys and probably, running pre-configured PowerShell scripts might be the faster way to do it.

For this initial walkthrough, we're going to use the Azure portal and create an Unsecure cluster with no certificates, so it is faster to get started. However, it is highly recommended to create a secure cluster for production workloads, though, since anyone can anonymously connect to an unsecure cluster and perform management operations.

### Create the cluster

First, log in to the Azure portal at http://portal.azure.com with your subscription credentials.
If you don't have an Azure subscription, create a [free Azure account](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) before you begin.

1. Click the **New** button found on the upper left-hand corner of the Azure portal.
2. Select **Compute** from the **New** blade and then **type "Service Fabric" in the Search** edit-box and hit enter. Then select **Service Fabric Cluster** from the blade, as shown below:

![image](https://user-images.githubusercontent.com/1712635/30459069-36dfec12-9963-11e7-8d5e-b32529ab9826.png)

3. Fill out the Service Fabric **Basics** form. For **Operating system**, select "**Windows Server 2016 Datacenter with Containers**" The user name and password entered here is used to log in to the virtual machine. For **Resource group**, create a new one. A resource group is a logical container into which Azure resources are created and collectively managed. When complete, click OK. 

See screenshot below as reference.
![image](https://user-images.githubusercontent.com/1712635/30459153-c24dfa8c-9963-11e7-92ec-95b151d12c73.png)

4. Fill out the **Cluster configuration** form. For **Node type count**, enter "1".
![image](https://user-images.githubusercontent.com/1712635/30459334-e1b02412-9964-11e7-8bf1-a14b39f66e07.png)

5. Select **Node type 1 (Primary)** and fill out the **Node type configuration** form. Enter a node type name (like "noded1v2" which is based on the type of the VM to be selected)  and set the [Durability tier](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity#the-durability-characteristics-of-the-cluster) to "**Bronze**." Select a VM size.

Node types define the VM size, number of VMs, custom endpoints, and other settings for the VMs of that type. Each node type defined is set up as a separate virtual machine scale set, which is used to deploy and managed virtual machines as a set. Each node type can be scaled up or down independently, have different sets of ports open, and can have different capacity metrics. The first, or primary, node type is where Service Fabric system services are hosted and must have five or more VMs.

For any production deployment, [capacity planning](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity) is an important step. For this quick start, however, you aren't running applications so select a D1_V2 Standard VM size. Select "Silver" for the [reliability tier](https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-capacity#the-reliability-characteristics-of-the-cluster) and an initial virtual machine scale set **capacity of 5** VMs.

Custom endpoints open up ports in the Azure load balancer so that you can connect with applications running on the cluster. It is IMPORTANT that you enter at least the ports to be used by the eShopModernized applications.

The list below are ports used by eShopModernizing apps and also other ports used by eShopOnContainers, if you want to deploy multiple applications in the same SF cluster:

    5114, 5433, 80, 81, 82, 83, 84, 85, 88, 8080, 8888, 1433, 443, 5100, 5101, 5102, 5103, 5104, 5105, 5106, 5107, 5108, 5109, 5110, 5112, 5113, 5115, 15672, 5672, 6379 

If you forget any port, you can always download the Azure ARM metadata from your cluster and re-publish.
An additional good way not to need so many ports is to manage a PREFIX per application so you re-use the same port across multiple services and discriminate services based on that PREFIX by using the SF **REVERSE PROXY**.





## Deploying from VSTS CD pipeline to Service Fabric  
- TBD (Plain)



