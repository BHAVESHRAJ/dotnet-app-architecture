##  Overview
Windows Containers should be used as a way to improve deployments to production, development and test environments of existing .NET applications based on .NET Framework technologies like MVC, Web Forms or WCF.

##  Goals for this walkthrough
Show you several alternatives on how to containerize an existing .NET Framework application:

1.	Containerized your application through Visual Studio 2017 Tools for Docker (VS 2017 or later).
2.	Containerized your application by manually adding the dockerfiles and using the Docker CLI.
3.	Containerized your application through Img2Docker tool (Open Source tool from Docker)

This Walkthrough covers the three approaches although it offers further details for the VS 2017 Tools for Docker approach.

##  Scenario
The diagram below shows the scenario for the containerized eShop legacy applications.
![image](https://user-images.githubusercontent.com/1712635/30395628-9c4bff98-987b-11e7-82ca-89a1648f3bdc.png)

## Prerequisites
- Windows 10 (For the developer machine)
- [Docker for Windows (Docker CE for Windows)](https://store.docker.com/editions/community/docker-ce-desktop-windows)
- Visual Studio 2017 (VS 15.3.3 or later)

## How to containerize your existing .NET applications with Visual Studio

Before you run the solution, you must make sure that you configure Docker to use Windows Containers. To do that, you right-click the Docker taskbar icon in Windows and select **Switch to Windows Containers**, as shown in the figure below.

![image](https://user-images.githubusercontent.com/1712635/30396197-b9d4e0be-987d-11e7-9e76-e982ab184e54.png)

If the menu item says "Switch to Linux containers", you are already running Docker with Windows Containers.

----------------------------------------------
--- Older simplified procedure - TO BE REMOVED
----------------------------------------------

## How to: dockerize the app
1. Add Docker files to the project:
   * In Visual Studio right click on the project -> Add-> Docker support
   * The docker-compose files are created plus the dcproj.
2. Add the environment variables to the docker-compose.override by using the [.env file](https://github.com/dotnet-architecture/eShopModernizing/blob/master/eShopModernizedMVCSolution/.env). Containers will use docker-compose environment variables and settings overriding values at the web.config, so the needed settings must be set at the docker-compose files and .env file. 
This environment variables must be setin the application and used instead of the web.config application settings. In our apps this is done in the CatalogConfiguration class.

## How to: run application in Windows Server 2016 with Containers
1. Create the docker image:
   * Build the solution in Release to build the eshopmodernizedmvc image.
   * When the build is done, open a Powershell prompt and execute ```docker images``` and in the list of images must appear eshopmodernizedmvc with tag _latest_
2. Publish the image in the Container Registry, in this case ACR:
   * Create one ACR on Azure. Take note of the address (e.g. myprivateacr.azurecr.io) and the user and password of the registry.
   * Login to the container registry. From a Powershell execute ```docker login -u dockerUser -p dockerPassword myprivateacr.azurecr.io``` using the values of your ACR
   * Add to the image our ACR address as a prefix to indicate where it must be published. Execute ```docker tag eshopmodernizedmvc myprivateacr.azurecr.io/eshopmodernizedmvc``` to mark it for publishing in the ACR. After this if you execute ```docker images``` this new _myprivateacr.azurecr.io/eshop/modernizedmvc must appear in the list of images.
   * Publish the tagged image executing ```docker push myprivateacr.azurecr.io/eshopmodernizedmvc```
   * Note: to publish in Docker hub instead of ACR, the login step is the same (with Docker Hub credentials), and skip the tag step because by default docker will publish to Docker Hub.
3. Run the image in the VM:
   * Create one VM in Azure. Select Windows Server 2016 Datacenter with containers. This way Docker is already installed and configured.
   * Install docker-compose. Following this [link](https://docs.docker.com/compose/install/#install-compose). Basically execute with admin rights from Powershell, with the last version, this command:  

      ```Invoke-WebRequest "https://github.com/docker/compose/releases/download/$dockerComposeVersion/docker-compose-Windows-x86_64.exe" -UseBasicParsing -OutFile $Env:ProgramFiles\docker\docker-compose.exe```

   * Copy the files _docker-compose.nobuild.yml_, _docker-compose.override.yml_ and _.env_ to the VM in a folder.
   * Edit the .env to put the IP of the VM in the variable.
   * Edit the _docker-compose.nobuild_ file to add the prefix of your ACR eshop/modernizedmvc:

          > image:myprivateacr.azurecr.io/eshop/modernizedmvc
 
   * If your image is in a private registry, login first. For ACR would be to execute in the VM ```docker login -u dockerUser -p dockerPassword myprivateacr.azurecr.io```.
   * Run ```docker-compose -f .\docker-compose.nobuild.yml -f .\docker-compose.override.yml up```. The first time the images will be downloaded from the registry, so this step can take some minutes the initial execution.
   * After this open the browser and write http://{ip of the VM}:5114 and the app should open.
 

